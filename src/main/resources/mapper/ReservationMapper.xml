<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lois.management.mapper.ReservationMapper">

    <select id="findAll" resultType="Reservation">
        SELECT
        ROW_NUMBER() OVER (ORDER BY r.id DESC) AS rowNumber,
        r.*,
        c.flavor AS cakeFlavor
        FROM reservations r
        JOIN cakes c ON r.cake_id = c.id
        ORDER BY r.id DESC
    </select>

    <select id="findAllCakeFlavor" resultType="Cake">
        SELECT id, flavor
        FROM cakes
    </select>

    <select id="findById" parameterType="long" resultType="Reservation">
        SELECT
        r.*,
        c.flavor AS cakeFlavor
        FROM reservations r
        JOIN cakes c ON r.cake_id = c.id
        WHERE r.id = #{id}
    </select>

    <select id="findByContactSuffix" resultType="Reservation">
        SELECT
        ROW_NUMBER() OVER (ORDER BY r.id DESC) AS rowNumber,
        r.*,
        c.flavor AS cakeFlavor
        FROM reservations r
        JOIN cakes c ON r.cake_id = c.id
        WHERE r.contact LIKE CONCAT('%', #{suffix})
        ORDER BY r.id DESC
    </select>

    <select id="findByPickupStatus" resultType="Reservation">
        SELECT
        ROW_NUMBER() OVER (ORDER BY r.res_date ASC, r.res_time ASC) AS rowNumber,
        r.*,
        c.flavor AS cakeFlavor
        FROM reservations r
        JOIN cakes c ON r.cake_id = c.id
        WHERE r.pickup_status = #{pickupStatus}
        AND r.res_date = CURRENT_DATE()
        ORDER BY r.res_date ASC, r.res_time ASC
    </select>

    <select id="findTodayByPickupStatusWaiting" resultType="Reservation">
        SELECT
        ROW_NUMBER() OVER (ORDER BY r.res_date ASC, r.res_time ASC) AS rowNumber,
        r.*,
        c.flavor AS cakeFlavor
        FROM reservations r
        JOIN cakes c ON r.cake_id = c.id
        WHERE r.pickup_status = 'WAITING'
        AND r.res_date = CURRENT_DATE()
        ORDER BY r.res_date ASC, r.res_time ASC
    </select>

    <select id="findFromTodayByPickupStatusWaiting" resultType="Reservation">
        SELECT
        ROW_NUMBER() OVER (ORDER BY r.res_date ASC, r.res_time ASC) AS rowNumber,
        r.*,
        c.flavor AS cakeFlavor
        FROM reservations r
        JOIN cakes c ON r.cake_id = c.id
        WHERE r.pickup_status = 'WAITING'
        AND r.res_date >= CURRENT_DATE()
        ORDER BY r.res_date ASC, r.res_time ASC
    </select>

    <select id="findByDateAndPickupStatusWaiting"
            parameterType="java.time.LocalDate"
            resultType="Reservation">
        SELECT
        ROW_NUMBER() OVER (ORDER BY r.res_date ASC, r.res_time ASC) AS rowNumber,
        r.*,
        c.flavor AS cakeFlavor
        FROM reservations r
        JOIN cakes c ON r.cake_id = c.id
        WHERE r.pickup_status = 'WAITING'
        AND r.res_date = #{date}
        ORDER BY r.res_date ASC, r.res_time ASC
    </select>


    <select id="sortByPickUpTime" resultType="Reservation">
        SELECT id, res_date, res_time, cake_id, cake_size, contact
        FROM reservations
        WHERE id = #{id}
    </select>

    <select id="findTodayOrderByPickUpTime" resultType="Reservation">
        SELECT
        ROW_NUMBER() OVER (ORDER BY r.res_time ASC) AS rowNumber,
        r.*,
        c.flavor AS cakeFlavor
        FROM reservations r
        JOIN cakes c ON r.cake_id = c.id
        WHERE r.res_date = CURRENT_DATE()
        AND (r.contact IS NULL OR r.contact != 'ON_SITE')
        ORDER BY r.res_time ASC
    </select>

    <select id="findAllOrderByPickUpTime" resultType="Reservation">
        SELECT
        ROW_NUMBER() OVER (ORDER BY r.res_date DESC, r.res_time DESC) AS rowNumber,
        r.*,
        c.flavor AS cakeFlavor
        FROM reservations r
        JOIN cakes c ON r.cake_id = c.id
        ORDER BY r.res_date DESC, r.res_time DESC
    </select>

    <select id="findFromTodayOrderByPickUpTime" resultType="Reservation">
        SELECT
        ROW_NUMBER() OVER (ORDER BY r.res_date ASC, r.res_time ASC) AS rowNumber,
        r.*,
        c.flavor AS cakeFlavor
        FROM reservations r
        JOIN cakes c ON r.cake_id = c.id
        WHERE r.res_date >= #{fromDate}
        ORDER BY r.res_date ASC, r.res_time ASC
    </select>

    <select id="findTodayForToMakeCalc" resultType="Reservation">
        SELECT
        r.*,
        c.flavor AS cakeFlavor
        FROM reservations r
        JOIN cakes c ON r.cake_id = c.id
        WHERE r.res_date = CURRENT_DATE()
    </select>

    <select id="findByDateOrderByPickUpTime"
            parameterType="java.time.LocalDate"
            resultType="Reservation">
        SELECT
        ROW_NUMBER() OVER (ORDER BY r.res_time ASC) AS rowNumber,
        r.*,
        c.flavor AS cakeFlavor
        FROM reservations r
        JOIN cakes c ON r.cake_id = c.id
        WHERE r.res_date = #{date}
        AND (r.contact IS NULL OR r.contact != 'ON_SITE')

        ORDER BY r.res_time ASC
    </select>

    <select id="findTodayOrderByCreatedAtDesc" resultType="Reservation">
        SELECT
        ROW_NUMBER() OVER (ORDER BY r.created_at DESC, r.id DESC) AS rowNumber,
        r.*,
        c.flavor AS cakeFlavor
        FROM reservations r
        JOIN cakes c ON r.cake_id = c.id
        WHERE r.res_date = CURDATE()
        ORDER BY r.created_at DESC, r.id DESC
    </select>

    <select id="findFromTodayOrderByCreatedAtDesc" resultType="Reservation">
        SELECT
        ROW_NUMBER() OVER (ORDER BY r.created_at DESC, r.id DESC) AS rowNumber,
        r.*,
        c.flavor AS cakeFlavor
        FROM reservations r
        JOIN cakes c ON r.cake_id = c.id
        WHERE r.res_date >= CURDATE()
        ORDER BY r.created_at DESC, r.id DESC
    </select>

    <select id="findByDateOrderByCreatedAtDesc" parameterType="java.time.LocalDate" resultType="Reservation">
        SELECT
        ROW_NUMBER() OVER (ORDER BY r.created_at DESC, r.id DESC) AS rowNumber,
        r.*,
        c.flavor AS cakeFlavor
        FROM reservations r
        JOIN cakes c ON r.cake_id = c.id
        WHERE r.res_date = #{date}
        ORDER BY r.created_at DESC, r.id DESC
    </select>

    <select id="existsExactSameReservation" parameterType="Reservation" resultType="boolean">
        SELECT COUNT(*)
        FROM reservations
        WHERE contact = #{contact}
        AND res_date = #{resDate}
        AND res_time = #{resTime}
        AND cake_id = #{cakeId}
    </select>

    <select id="existsByContact" parameterType="string" resultType="boolean">
        SELECT COUNT(*)
        FROM reservations
        WHERE contact = #{contact}
    </select>

    <insert id="insert" parameterType="Reservation" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO reservations (res_date, res_time, cake_id, contact, paid, note)
        VALUES (#{resDate}, #{resTime}, #{cakeId}, #{contact}, #{paid}, #{note})
    </insert>

    <insert id="insertOnSite" parameterType="Reservation" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO reservations (res_date, res_time, cake_id, cake_size, contact, paid, note)
        VALUES (#{resDate}, #{resTime}, #{cakeId}, #{cakeSize}, #{contact}, #{paid}, #{note})
    </insert>

    <update id="updateApi" parameterType="com.lois.management.domain.Reservation"> <!-- âœ… id=update -->
        UPDATE reservations
        <set>
            <if test="resDate != null">res_date = #{resDate},</if>
            <if test="resTime != null">res_time = #{resTime},</if>
            <if test="contact != null">contact = #{contact},</if>
            <if test="paid != null">is_paid = #{paid},</if>
            <if test="status != null">status = #{status},</if>
            <if test="note != null">note = #{note},</if>
            updated_at = NOW()
        </set>
        WHERE id = #{id}
    </update>

    <update id="update" parameterType="Reservation">
        UPDATE reservations
        <set>
            <if test="reservation.resDate != null">res_date = #{reservation.resDate},</if>
            <if test="reservation.resTime != null">res_time = #{reservation.resTime},</if>
            <if test="reservation.cakeSize != null">cake_size = #{reservation.cakeSize},</if>
            <if test="reservation.contact != null">contact = #{reservation.contact},</if>
            <if test="reservation.paid != null">paid = #{reservation.paid},</if>
            <if test="reservation.note != null">note = #{reservation.note},</if>
            updated_at = NOW()
        </set>
        WHERE id = #{id}
    </update>

    <update id="updatePickupStatus">
        UPDATE reservations
        SET
            pickup_status = #{pickupStatus},
            picked_up_at = #{pickedUpAt}
        WHERE id = #{id}
    </update>

    <update id="updateMakeStatus">
        UPDATE reservations
        SET
        make_status = #{makeStatus}
        WHERE id = #{id}
    </update>

    <delete id="delete" parameterType="long">
        DELETE FROM reservations
        WHERE id = #{id}
    </delete>

</mapper>