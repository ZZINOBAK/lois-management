<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Lois â€“ Cake Reservations</title>

    <link rel="stylesheet" th:href="@{/css/index.css}">
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">

    <script>
        function showPreparing(){ alert("ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤."); }

    </script>


    <script src="https://unpkg.com/htmx.org@1.9.11"></script>

    <!--    ìƒì„¸ìš© ì¶”ê°€ ì½”ë“œ-->
    <style>
        .detail-row.hidden {
            display: none;
        }
        .detail-row {
            padding: 10px;
            background: #f9f9f9;
            border-left: 4px solid #ddd;
            margin-bottom: 10px;
        }

        /* ë§› ë²„íŠ¼ */
        .flavor-btn {
            min-width: 90px;
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid #dde2dd;
            background-color: #f8f8f8;
            font-size: 0.9rem;
            line-height: 1.2;
        }
        .flavor-btn.ready {
            text-decoration: line-through;
            opacity: 0.6;
        }

        /* ê²°ì œ ë±ƒì§€ */
        .badge-paid {
            padding: 4px 10px;
            border-radius: 999px;
            background: #2f7d4a;
            color: #fff;
            font-size: 0.75rem;
        }
        .badge-unpaid {
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid #ccc;
            font-size: 0.75rem;
        }

    </style>
    <script>
        function toggleDetailRow(event, id) {
        // ë²„íŠ¼ì´ë‚˜ ë²„íŠ¼ ì•ˆìª½ì„ í´ë¦­í•œ ê²½ìš°ëŠ” ìƒì„¸ í† ê¸€ ì•ˆí•¨
        if (event.target.closest('button')) {
            return;
        }

        const detail = document.getElementById('detail-' + id);
        if (detail) {
            detail.classList.toggle('hidden');
        }
    }
    </script>

</head>

<body>
<div class="wrap">


    <!-- âœ¨ ê³µí†µ í—¤ë” -->
    <header th:replace="~{fragments/header :: site-header}"></header>

    <main>


    <section class="content">
        <div class="list-header">
            <div>
                <h2 class="section-title">ì¼€ì´í¬ ì˜ˆì•½ ë¦¬ìŠ¤íŠ¸</h2>
                <div class="filters">
                    <!-- ì „ì²´: scope=all -->
                    <button class="chip"
                            type="button"
                            hx-get="/reservations/sort?scope=all"
                            hx-target="#list"
                            hx-swap="innerHTML">
                        ì „ì²´
                    </button>
                    <button class="chip" type="button" onclick="showPreparing()">ë‚ ì§œ</button>
                    <!-- ì˜¤ëŠ˜: scope=today -->
                    <button class="chip"
                            type="button"
                            hx-get="/reservations/sort?scope=today"
                            hx-target="#list"
                            hx-swap="innerHTML">
                        ì˜¤ëŠ˜
                    </button>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½ ì˜ì—­ ë¬¶ê¸° -->
            <div class="actions-right">
                <!-- ì˜ˆì•½í•˜ê¸° ë²„íŠ¼ -->
                <a class="cta" th:href="@{/reservations/new}" role="button">
                    <div class="title">ì˜ˆì•½í•˜ê¸°</div>
                </a>

                <!-- ìƒ˜í”Œ ë²„íŠ¼ (ì‘ê²Œ) -->
                <form th:action="@{/reservations/sample}" method="post">
                    <button class="cta-sample" type="submit">ìƒ˜í”Œ</button>
                </form>
            </div>
        </div>

        <!-- ğŸ”¹ ë ˆì „ë“œ(ì™¼ìª½) + ê²€ìƒ‰í¼(ì˜¤ë¥¸ìª½) í•œ ì¤„ -->
        <div class="reservation-toolbar">
            <div class="reservation-legend">
                <span class="legend-chip legend-sameday"></span>
                <span>ì˜¤ëŠ˜ ìƒì„±ëœ ì˜ˆì•½</span>
            </div>

            <form class="reservation-search phone-search-form"
                  method="get"
                  th:action="@{/reservations/search}"
                  th:attr="hx-get=@{/reservations/search}"
                  hx-target="#list"
                  hx-swap="innerHTML">

                <label for="contactSuffix" class="search-label phone-search-label">
                    íœ´ëŒ€í° ë’·ìë¦¬
                </label>

                <div class="phone-search-inline">
                    <input id="contactSuffix"
                           name="contactSuffix"
                           type="text"
                           inputmode="numeric"
                           pattern="[0-9]{4}"
                           maxlength="4"
                           minlength="4"
                           class="phone-input"
                           required>

                    <button type="submit"
                            class="phone-search-btn">
                        ê²€ìƒ‰
                    </button>
                </div>
            </form>
        </div>

        <!-- ğŸ“¦ í”½ì—…ì˜ˆì •ë§Œ ë³´ê¸° ë²„íŠ¼ (ì´ê±´ ê·¸ëŒ€ë¡œ ì•„ë˜ì— ë‘ ) -->
        <button type="button"
                class="pickup-filter-btn"
                th:attr="hx-get=@{/reservations/filter(pickupStatus='WAITING')}"
                hx-target="#list"
                hx-swap="innerHTML">
            í”½ì—…ì˜ˆì •ë§Œ
        </button>


        <div class="thead">
            <div>ì—°ë²ˆ</div>
            <div>ë‚ ì§œ</div>
            <div>ì‹œê°„</div>
            <div>ë§›</div>
            <div>í˜¸ìˆ˜</div>
            <div>ì—°ë½ì²˜</div>
            <div>ê²°ì œ</div>
            <div>í”½ì—…</div>
<!--            <div style="text-align:right">ìˆ˜ì •/ì‚­ì œ</div>-->
            <div>ìˆ˜ì •/ì‚­ì œ</div>
        </div>

        <div id="list" th:fragment="list">
            <!--        <div id="list">-->
            <!--        <div th:each="r : ${reservations}" class="row">-->



            <!--        ì—¬ê¸°ë¶€í„°-->
            <div th:each="r : ${reservations}"
                 th:insert="~{reservation/dashboard :: rowFragment(r=${r})}">

            <!--                 th:insert="~{reservation/dashboard :: rowFragment(r=${r})}">-->
                <div th:fragment="rowFragment(r)" th:id="'row-block-' + ${r.id}">

                <!-- ìš”ì•½ í–‰ -->
                    <div class="row summary-row"
                         th:id="'row-' + ${r.id}"
                         th:onclick="|toggleDetailRow(event, ${r.id})|"
                         th:classappend="${r.pickupStatus == 'PICKED'} ? ' picked' : ''"
                         th:attr="data-sameday=${r.createdAt != null
                             and #temporals.format(r.createdAt, 'yyyy-MM-dd') == #temporals.format(today, 'yyyy-MM-dd')}">

                        <!-- ì—¬ê¸°ê¹Œì§€ í–‰ í”„ë ˆê·¸ë¨¼íŠ¸ ì¶”ê°€ì½”ë“œ -->
                        <div th:text="${r.rowNumber}"></div><!-- ì—°ë²ˆ -->
                        <div th:text="${#temporals.format(r.resDate, 'yyyy-MM-dd')}"></div>
                        <div th:text="${#temporals.format(r.resTime, 'HH:mm')}"></div>
                        <!--                        <div class="ellipsis" th:text="${r.cakeFlavor}"></div>-->
                        <!-- ğŸ° ë§› / ì œì‘ ìƒíƒœ ë²„íŠ¼ -->
                        <button th:replace="~{reservation/dashboard :: makeButton(r=${r})}"></button>
                        <div th:text="${r.cakeSize}"></div>
<!--                        <div class="ellipsis" th:text="${r.contact}"></div>-->
                        <div class="phone" th:text="${r.contact}"></div>
                        <div>
                            <span th:classappend="${r.paid} ? 'badge-paid' : 'badge-unpaid'">
                                <span th:text="${r.paid} ? 'ê²°ì œì™„ë£Œ' : 'ë¯¸ê²°ì œ'"></span>
                            </span>
                        </div>
                        <div class="pickup-cell">
                            <div class="pickup-cell">
                                <!-- ğŸ“¦ í”½ì—… ìƒíƒœ ë²„íŠ¼ -->
                                <button th:replace="~{reservation/dashboard :: pickupButton(r=${r})}"></button>
                            </div>
                        </div>
                        <div class="actions">
                            <button class="btn"
                                    type="button"
                                    th:onclick="|location.href='@{/reservations/{id}/edit(id=${r.id})}'|">
                                ìˆ˜ì •
                            </button>
                            <button
                                    class="btn"
                                    type="button"
                                    th:onclick="|openConfirmModal('@{/reservations/{id}(id=${r.id})}')|">
                                ì‚­ì œ
                            </button>
                        </div>
                    </div>


                    <!-- ìƒì„¸ í–‰ -->
                    <div class="detail-row hidden"
                         th:id="'detail-' + ${r.id}">
                        <div><b>ìš”ì²­ì‚¬í•­:</b> <span th:text="${r.note}"></span></div>
                        <div><b>ì´ˆ:</b> <span th:text="${r.candles}"></span></div>
                        <div><b>í”½ì—…ì‹œê°„:</b> <span th:text="${r.pickedUpAt}"></span></div>
                        <div><b>ìƒì„±ì¼:</b> <span th:text="${r.createdAt}"></span></div>

                    </div>
                </div>


                <!-- ========================= -->
                <!--  ì œì‘ ìƒíƒœ í† ê¸€ ë²„íŠ¼ ì¡°ê° -->
                <!-- ========================= -->
                <button
                        th:fragment="makeButton(r)"
                        type="button"
                        class="flavor-btn ellipsis"
                        th:text="${r.cakeFlavor}"
                        th:classappend="${r.makeStatus == 'READY'} ? ' ready' : ''"
                        th:attr="hx-patch=@{/reservations/{id}/make-toggle(id=${r.id})}"
                        hx-swap="outerHTML">
                </button>

                <!-- ========================= -->
                <!--  í”½ì—… ìƒíƒœ í† ê¸€ ë²„íŠ¼ ì¡°ê° -->
                <!-- ========================= -->
                <button
                        th:fragment="pickupButton(r)"
                        class="btn pickup-btn"
                        th:classappend="${r.pickupStatus == 'PICKED'} ? ' picked-btn' : ''"
                        th:attr="hx-patch=@{/reservations/{id}/pickup-toggle(id=${r.id})}"
                        hx-swap="outerHTML">
                    <span th:text="${r.pickupStatus == 'PICKED' ? 'í”½ì—…ì™„ë£Œ' : 'í”½ì—…ì˜ˆì •'}"></span>
                </button>
            </div>
            <!-- âœ… ì˜¤ëŠ˜(scope == 'today')ì¼ ë•Œë§Œ ì¸ì‡„ ë²„íŠ¼ ë³´ì´ê¸° -->
            <div th:if="${scope == 'today'}"
                 class="list-print-actions"
                 style="display:flex; justify-content:flex-end; margin: 8px 0;">
                <button type="button"
                        class="chip"
                        onclick="window.open('/reservations/print', '_blank')">
                    ì˜¤ëŠ˜ ì¼€ì´í¬ ë¦¬ìŠ¤íŠ¸ ì¸ì‡„
                </button>
            </div>
        </div>
    </section>


    <!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
    <div id="confirm-modal" class="confirm-modal hidden">

        <div class="confirm-modal__content">
            <p class="confirm-modal__text">ì •ë§ ì´ ì˜ˆì•½ì„ ì‚­ì œí•˜ì‹œê² ì–´ìš”?</p>

            <div class="confirm-modal__actions">
                <button id="confirm-yes"
                        class="confirm-modal__btn confirm-modal__btn--yes">
                    ì˜ˆ
                </button>
                <button id="confirm-no"
                        class="confirm-modal__btn confirm-modal__btn--no">
                    ì•„ë‹ˆì˜¤
                </button>
            </div>
        </div>
    </div>
    </main>

    <!-- âœ¨ ê³µí†µ í‘¸í„° -->
    <footer th:replace="~{fragments/footer :: site-footer}"></footer>

</div>

<script>
    let pendingDeleteUrl = null;

    function openConfirmModal(url) {

        pendingDeleteUrl = url;
        document.getElementById("confirm-modal").classList.remove("hidden");
    }

    function closeConfirmModal() {
        pendingDeleteUrl = null;
        document.getElementById("confirm-modal").classList.add("hidden");
    }

    document.getElementById("confirm-yes").addEventListener("click", function() {
        if (pendingDeleteUrl) {
            htmx.ajax('DELETE', pendingDeleteUrl, {
                target: '#list',
                swap: 'innerHTML'
            });
        }
        closeConfirmModal();
    });

    document.getElementById("confirm-no").addEventListener("click", closeConfirmModal);
</script>
<script>
    // í”½ì—… ë²„íŠ¼ ëˆŒë €ì„ ë•Œ í–‰ì— picked í´ë˜ìŠ¤ í† ê¸€
    document.addEventListener('click', function (e) {
      const btn = e.target.closest('.pickup-btn');
      if (!btn) return;

      const row = btn.closest('.summary-row');
      if (!row) return;

      row.classList.toggle('picked');
    });
</script>
</body>
</html>
